<!doctype html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estudio de la Web Audio API. Detector de Armónicos.</title>

 <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link href="google-code-prettify/prettify.css" rel="stylesheet" type="text/css">

    <!-- Custom styles for this template -->
    <link href="bootstrap/css/offcanvas.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/docs.css">
	<link rel="stylesheet" type="text/css" href="bootstrap/css/pygments-manni.css">
     <meta name="description" content="Algoritmo de detección armónica Web Audio API. Javascript">
     <meta name="author" content="Luis Javier Gil Bobillo">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
<link rel="icon" href="images/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="images/icono57.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/icono72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/icono114.png">
<style>
.warning1{
	background-color:#fffdf1;
	
	}
	
/* Ejemplos*/
.ejwarning1{
	background-color:#fffdf1;
	
	}
.ejwarning{
	background-color:#fcf8e3;}
.ejsuccess{
	background-color:#d0e9c6;}	
    
    .nota_baja{ background-color: #E43C3F;color:#ccc;}
    .nota_aprox{ background-color: #EA191C; color:#FFFFFF;}
    .nota_alta{ background-color: #8F3133;color:#ccc;}
	.nota_baja_ley{ background-color: #E43C3F;color:#ccc;}
    .nota_aprox_ley{ background-color: #EA191C; color:#FFFFFF;}
    .nota_alta_ley{ background-color: #8F3133;color:#ccc;}
.volumen{display:none;}
button sup { font-size:9px;}
 #provisional{ position:absolute; color:#FFF}
</style>

<script type="text/javascript" src="comunes.js"></script>
<script type="text/javascript"  src="notas.js"></script>
<script>
var intervalosnota;
//------Si USAMOS  MICrófono

function sonidoDirecto() {
    if (suena)
        playPause();


    if (pausa) {
        if (!suena && pausa) {
            //Vengo del silencio-> borro texto en marco
            var parrafo = document.getElementById("provisional");
            parrafo.parentNode.removeChild(parrafo);
        }

        //Cambiar estadomic
        textoPausaMic();
        tomarEntradaMic({
            audio: true
        }, al_aire);
        pausa = false;
    } else {

        miFuente.disconnect();
        //Estado del botón de entrada de mic
        textoPlayMic();
        //Vengo del silencio-> borro texto en marco
        pulsaElBotonReproducir();
        pausa = true;
        //tomarEntradaMic({audio:true}, al_aire);
    }
}


function error() {
    alert('Falló la generación de la cadena de Audio. Safari no soporta getUserMedia aún....');
}

function tomarEntradaMic(medio, llamada) {
    try {
        navigator.getUserMedia =
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia;
        navigator.getUserMedia(medio, llamada, error);
    } catch (e) {
        alert('Nos aprarece algún error en la toma de entrada de micrófono... :' + e);
    }
}

function al_aire(entrada) {

    var fuente = contextoDeAudio.createMediaStreamSource(entrada);
    // crea analizador
    contextoDeAudio.analizador = contextoDeAudio.createAnalyser();
    contextoDeAudio.analizador.fftSize = 2048;
    //cadenaDeAudio(fuente);
    fuente.connect(contextoDeAudio.analizador);
    requestAnimationFrame(dibujaEspectro.bind(this));
    miFuente = fuente;


}

//establecemos la cadena de audio 

function cadenaDeAudio(fuente) {
    contextoDeAudio.analizador = contextoDeAudio.createAnalyser();
    //Analizador
    contextoDeAudio.analizador.smoothingTimeConstant = 0.8;
    contextoDeAudio.analizador.fftSize = 2048;
    contextoDeAudio.analizador.minDecibels = -120;
    contextoDeAudio.analizador.maxDecibels = 0;

    if (esFirefox) {
        contextoDeAudio.volumen = contextoDeAudio.createGain();
    } else {
        contextoDeAudio.volumen = contextoDeAudio.createGainNode();
    }

    // Ruta de audio conexiones
    fuente.connect(contextoDeAudio.volumen);
    contextoDeAudio.volumen.connect(contextoDeAudio.analizador);
    contextoDeAudio.volumen.connect(contextoDeAudio.destination);
    return fuente;
}

function dibujaEspectro() {
        //Función de dibujo y análisis.
        //FRECUENCIA: Tomamos un byte de enteros, array de 256 valores de amplitud y 1028 muestras
        var ByteDatosFrec = new Uint8Array(contextoDeAudio.analizador.frequencyBinCount);
        contextoDeAudio.analizador.getByteFrequencyData(ByteDatosFrec);

        //llamamos a las funciones de dibujo (Canvas de resolución y forma de onda)
        dibujarEspectroDeResolucion(ByteDatosFrec);
        dibujarOnda();

        //Canvas principal
        var canvas = document.getElementById('principal');
        var ctx = canvas.getContext('2d');
        ANCHO = document.getElementById('pantalla').offsetWidth - 80;
        ALTO = 256;
        canvas.width = ANCHO;
        canvas.height = ALTO;
        var bar_width = 1;
        ctx.clearRect(0, 0, ANCHO, ALTO);
        //dibujo línea comparador
        dibujarlineacomparador(ctx, 0, ANCHO, 128);
        dibujarescala(ctx, ALTO, ANCHO);
        //---- VISUALIZAMOS ALGUNAS VARIABLES
        //console.log(ByteDatosFrec);
        var nyquist = contextoDeAudio.sampleRate / 2;
        //console.log(nyquist);
        (document.querySelector(".nyquist")).innerHTML = nyquist;
        (document.querySelector(".arrayFreq")).innerHTML = ByteDatosFrec.length;
        (document.querySelector(".muestreo")).innerHTML = contextoDeAudio.sampleRate;
        (document.querySelector(".fftsize")).innerHTML = contextoDeAudio.analizador.fftSize;
        //--------------
        var NumerodeBarras = Math.round(ANCHO / ByteDatosFrec.length);
        var maximo = ByteDatosFrec[0];
        var pico = ByteDatosFrec[0];
        var valores = new Array();
        var posiciones = new Array();
        var valorespico = new Array();
        var posicionespico = new Array();
        //var posicionesordenadas = new Array();
        //var valoresordenados = new Array();
        //for (var i = 0; i < NumerodeBarras; i++) {
        //calculo directo del máximo	
        /*
			var losmayores = new Array();
			losmayores = Math.max.apply( Math, ByteDatosFrec );
			console.log(
			losmayores
			)	
			*/
        //Comparo valores mayores que el umbral
        for (var m = 0; m <= (ByteDatosFrec.length); m++) {
            var magnitud = ByteDatosFrec[m];
            var siguiente = ByteDatosFrec[m + 1];
            var anterior = ByteDatosFrec[m - 1];
            //variables dibujo
            var porcentaje = magnitud / 256;
            var altobarra = ALTO * porcentaje;
            var margen = ALTO - altobarra - 1;
            if ((magnitud > maximo) && (magnitud > siguiente) && (magnitud > anterior) && (magnitud > 128)) {

                pico = magnitud;
                //Creamos nuestra matriz de valores y posiciones
                valores.push(pico);
                posiciones.push(m);
                //Color blanco a los picos
                ctx.fillStyle = "rgb(225,225,225)";
                ctx.fillRect(m, margen, bar_width, altobarra);
                var pos = m;
                var frecuencia = ((pos * contextoDeAudio.sampleRate) / contextoDeAudio.analizador.fftSize);
            } else {

                //color oscuro al resto
                ctx.fillStyle = "rgb(112,96,94)"
                ctx.fillRect(m, margen, bar_width, altobarra);
            }
            //termina para los mayores de 100
            // Ajustar valores en el canvas
            /*var porcentaje = valor / 256;
				var altobarra = ALTO * porcentaje;
				var margen = ALTO - altobarra -1;
				*/
            //Mostramos en pantalla
            (document.querySelector(".valor")).innerHTML = pico;
            (document.querySelector(".picos")).innerHTML = valores.slice(0, 8);
            (document.querySelector(".posicion")).innerHTML = posiciones.slice(0, 10);
            (document.querySelector(".frecuencia")).innerHTML = frecuencia;
            //CORRESPONDENCIA DE NOTAS     

            if (contextoDeAudio.sampleRate == '48000' && sw == 0) {
                alert('La frecuencia de muestreo de su dispositivo de salida es de 48.000Hz. La aplicación funciona con el estandar de 44100Hz. Si tu S.O. es Mac, puedes cambiarla fácilmente en Utilidades-> Configuración de Audio y MIDI')
                sw = 1;
            }

            //Compruebo cuando he completado un ciclo de muestras 
            if (m == ByteDatosFrec.length) {
                //Si tengo valores marco la casilla de detección
                if (valores[0] != null) {
                    $('.db').css('background-color', '#5cb85c');
                    $('.ojo').removeClass('glyphicon-eye-close');
                    $('.ojo').addClass('glyphicon-eye-open');
                    $('.ojo').css('color', 'white');
                } else {
                    $('.db').css('background-color', '#f9f9f9');
                    $('.ojo').removeClass('glyphicon-eye-open');
                    $('.ojo').addClass('glyphicon-eye-close');
                    $('.ojo').css('color', 'rgb(51, 51, 51)');
                }
                //---- ordeno los armónicos de mayor nivel, para optimizar el comparador
                var valoresordenados = new Array();
                var posicionesordenadas = new Array();
                var frecuenciasordenadas = new Array();
                var objeto = new Array();
                for (i = 0; i <= valores.length; i++) {
                    objeto[i] = new Array(2);
                    objeto[i][0] = valores[i];
                    objeto[i][1] = posiciones[i];
                }
                objeto.sort(function(a, b) {
                    return b[0] - a[0];
                });
                for (i = 0; i < posiciones.length; i++) {
                    valoresordenados[i] = objeto[i][0];
                    posicionesordenadas[i] = objeto[i][1];
                    frecuenciasordenadas[i] = parseInt((posicionesordenadas[i] * contextoDeAudio.sampleRate) / contextoDeAudio.analizador.fftSize);
                }(document.querySelector(".posicionord")).innerHTML = posicionesordenadas.slice(0, 10);
                (document.querySelector(".frecuenciasordenadas")).innerHTML = frecuenciasordenadas.slice(0, 8);
                //console.log(posicionesordenadas);
                if (posiciones.length == 0) {
                    borra();
                }
                //console.log('posiciones: '+posiciones)
                //console.log('valores: '+valores)
                (document.querySelector(".nota")).innerHTML = '--';
                if (posiciones) {
                    (document.querySelector(".nota")).innerHTML = '?';
                    marca(posiciones);
                    //borra();
                    //comprobar todas las notas
                    //Notas--------
                    //comprobar todas las notas
                    comprobaciones(posiciones);
                }
            }
        } // fin bucle para valores mayores que el umbral
        requestAnimationFrame(dibujaEspectro.bind(this))

    } // fin dibujar espectro canvas principal y análisis


function dibujarEspectroDeResolucion(ByteDatosFrec) {
    //Canvas de resolución//dibujamos el espectro de **resolución**
    var espectro = document.querySelector('#canvasresolucion');
    var ctxe = espectro.getContext('2d');
    var ancho = document.getElementById('marco').offsetWidth - 80;
    espectro.width = ancho;
    espectro.height = 200;
    var alto = 200;
    var ancho_barra;
    var resolucion = 18;
    ctxe.clearRect(0, 0, ancho, alto);

    //Dibujamos el espectro de resolución
    var NumerodeBarras = Math.round(ancho / resolucion);
    //dibujamos las barras
    for (var i = 0; i < NumerodeBarras; i++) {
        //for (var i = 0; i < (datos_frecuencia.length); i++) {
        var magnitud = ByteDatosFrec[i];
        // ajustamos las variables para dibujarlas en el canvas
        //dibujamos tipo hue ;)
        var hue = i / ByteDatosFrec.length * 360
        ctxe.fillStyle = 'hsl(' + hue + ', 100%, 50%)';
        ctxe.fillRect(resolucion * i, alto - 20, resolucion - 2, -magnitud + 40);
        ctxe.fillStyle = "rgb(225,225,225)";
        ctxe.font = "8pt Helvetica";
        ctxe.fillText(i, resolucion * i, alto);
        if (i == 8) {
            ctxe.fillText('Mi', resolucion * i, 10);
        }
        if (i == 15) {
            ctxe.fillText('Mi', resolucion * i, 10);
        }
        if (i == 31) {
            ctxe.fillText('Mi', resolucion * i, 10);
        }
    }


}


//Dibujar forma de onda en la línea de tiempo
function dibujarOnda(tiempos) {
    //TIEMPO: creamos un array de bytes para dibujar la forma de onda:
    var tiempos = new Uint8Array(contextoDeAudio.analizador.frequencyBinCount);
    contextoDeAudio.analizador.getByteTimeDomainData(tiempos);
    var marcotiempo = document.querySelector('#canvasonda');
    var ctxo = marcotiempo.getContext('2d');
    var ancho = document.getElementById('marcoonda').offsetWidth - 80;
    marcotiempo.width = ancho;
    marcotiempo.height = 200;
    ctxo.fillStyle = 'white';
    ctxo.moveTo(0, 128);
    ctxo.lineTo(ancho, 128);
    ctxo.stroke();
    ctxo.fillText('0', 5, 128)

    // Dibujamdo el Gráfico en el dominio del tiempo.
    for (var i = 0; i < contextoDeAudio.analizador.frequencyBinCount; i++) {
        var valor = tiempos[i];
        var porcentaje = valor / 256;
        var amplitud = 256 * porcentaje;
        var ajuste = 256 - amplitud - 1;
        var anchopixel = ancho / contextoDeAudio.analizador.frequencyBinCount;
        ctxo.fillStyle = 'white';
        ctxo.fillRect(i * anchopixel, ajuste, 1, 2);

    }




}


//Check notas/porciones de fecuencia

function comprobar(intervalosNota, posiciones) {
    for (var i = 0; i < (intervalosNota.length); i++) {
        var a = posiciones.indexOf(intervalosNota[i]);
        if (a == -1) {
            return false;
        }
    }
    //alert('esta');
    //marca(intervalosNota, posiciones);
    //marcaencanvas(intervalosNota, posiciones);
    return true;
}

function marca(posiciones) {
    for (var i = 0; i < (posiciones.length); i++) {
        //$("#" + intervalosNota[i]).html(intervalosNota[i]) ;
        //console.log(intervalosNota[i]);
        if ($("#" + posiciones[i]) || $("." + posiciones[i])) {
            if ($("#" + posiciones[i]).hasClass('aprox')) {
                $("#" + posiciones[i]).addClass('warning')
            }
            if ($("." + posiciones[i]).hasClass('aprox1')) {
                $("." + posiciones[i]).addClass('warning1')
            } else {
                $("#" + posiciones[i]).addClass('success');
            }
        }
    }
}

function borra() {
        $("*").removeClass('success');
        $("*").removeClass('nota_aprox');
        $("*").removeClass('warning');
        $("*").removeClass('warning1');
        $("*").removeClass('nota_alta');
        $("*").removeClass('nota_baja');
    }
    //}
    // línea comparador---------

function dibujarlineacomparador(c, x1, x2, y) {
        c.lineWidth = 1;
        var adaptedY = Math.floor(y) + 0.5;
        c.beginPath();
        c.moveTo(x1, 128);
        c.lineTo(x2, 128);
        c.stroke();
    }
    //Escala 256 valores

function dibujarescala(c, ALTO, ANCHO) {
    c.font = "8pt Helvetica";
    var count = 0;
    var paso = 50;
    var margen = 5;
    var colHead = 0;
    var rowHead = 0;
    yScalar = (ALTO - colHead - margen) / (ALTO);
    for (i = ALTO; i >= 0; i -= paso) {
        y = colHead + (yScalar * count * paso);
        c.fillText(i, margen, y + margen)
        c.moveTo(rowHead, y)
        c.lineTo(ANCHO, y)
        count++;
    }
}

function potenciometro(slider) {
    if (contextoDeAudio.activeSourceCount > 0) {
        if (slider.id == 'volume') {
            var volume = slider.value;
            contextoDeAudio.volume.gain.value = volume;
        }
    }
}

function textoPlayMic() {

    var texto = $('#microfono');
    var icono = texto.find('span');
    texto.html('Usar micrófono&nbsp;');
    texto.append(icono);
    $('#microfono').removeClass('btn-warning');
    $('#microfono').addClass('btn-success');
    $('#iconom').removeClass('glyphicon glyphicon-pause');
    $('#iconom').addClass('glyphicon glyphicon-user');


}

function textoPausaMic() {

    var texto = $('#microfono');
    var icono = texto.find('span');
    texto.html('Pausar micrófono&nbsp;');
    texto.append(icono);
    $('#microfono').removeClass('btn-success');
    $('#microfono').addClass('btn-warning');
    $('#iconom').removeClass('glyphicon glyphicon-user');
    $('#iconom').addClass('glyphicon glyphicon-pause');
}
</script>


</head>

<body onload="prettyPrint();inicializar();">
    <div class="navbar navbar-inverse navbar-fixed-top bs-docs-nav">
        <div class="container">
            <div class="navbar-header">
                <button class="navbar-toggle" data-target=".bs-navbar-collapse"
                data-toggle="collapse" type="button"><span class=
                "sr-only">Despliega el menú</span></button> <a class=
                "navbar-brand" href="">El audio en la web</a>
            </div>

            <nav class="collapse navbar-collapse bs-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="index.html">Inicio</a></li>

                    <li class="active"><a href="afinadorb.html">Afinador
                    experimental</a></li>

                    <li><a href="comenzando.html">Ejemplos</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h3 class="text-muted">Análisis armónico</h3>
        </div>

        <div class="jumbotron" id="pantalla" data-placement="bottom" data-toggle="tooltip"  title=
                            "Este display muestra un análisis en frecuencia de la señal de audio, indicando los picos de frecuencia. Durante el análisis, estos picos serán considerados como armónicos y comprobaremos su correspondencia con las notas musicales generadas por una guitarra de afinación estándar. MI-LA-RE-SOL-SI-MI">
        <div id="espectro"><div class="marco"></div><div id="provisional"></div></div>
            <canvas height="200" id="principal" width="1024"></canvas>
        </div>

        <div class="row marketing">
            <div class="col-md-5">
                <div class="btn-group btn-group-lg">
                   <button id="play" class="btn btn-info " onclick="playPause(this)" type="button" >Reproducir <span  id="icono" class="glyphicon glyphicon-play"></span></button>
&nbsp;<button class=
                    "btn btn-default btn-success" id="microfono" onclick="sonidoDirecto()">Usar microfono <sup>*</sup> <span  id="iconom" class="glyphicon glyphicon-user"></span></button>
                </div><br>
                <sub>*Necesitas utilizar <a href=
                "http://www.google.es/intl/es/chrome/browser/" target=
                "_blank">Google Chrome</a></sub>

                <div class="alert alert-info volumen">
                    <ul class="list-unstyled">
                        <li><span>Volumen:</span></li>

                        <li><input id="volume" max="1" min="0" onchange=
                        "potenciometro(this)" step="0.01" type="range" value=
                        "1"></li>
                    </ul>
                </div>

               
                		<div class="bs-glyphicons">
                      <ul class="bs-glyphicons-list">
                        <li><span class="glyphicon glyphicon-music"></span><span class="glyphicon-class">NOTA: &nbsp;<span class="nota glyphicon-class">--</span></span></li>
                
                        <li><span class="glyphicon glyphicon-resize-full"></span><span class="glyphicon-class">Tamaño de la FFT</span> <span class="fftsize glyphicon-class">0</span></li>
                
                        <li><span class="glyphicon glyphicon-th-list"></span><span class="glyphicon-class">Frecuencia de Muestreo:</span> <span class=
                        "glyphicon-class muestreo">0</span></li>
                
                        <li><span class="glyphicon glyphicon-pushpin"></span><span class="glyphicon-class">Frecuencia de Nyquist:</span> <span class="nyquist glyphicon-class">0</span></li>
                
                        <li><span class="glyphicon glyphicon-resize-horizontal"></span><span class="glyphicon-class">Long. del Array de datos de frec. 8 Bits :</span> <span class=
                        "arrayFreq glyphicon-class">0</span></li>
                
                        <li><span class="glyphicon glyphicon-star-empty"></span><span class="glyphicon-class">Valor del máximo: &nbsp;</span><span class=
                        "valor glyphicon-class">0</span></li>
                
                        <li><span class="glyphicon glyphicon-list"></span><span class="glyphicon-class">Posiciones de los armónicos:&nbsp;</span><span class=
                        "posicion glyphicon-class">posicion</span></li>
                
                        <li><span class="glyphicon glyphicon-sort-by-attributes-alt"></span><span class="glyphicon-class">Posiciones&nbsp;</span><span class="posicionord glyphicon-class">-</span></li>
                
                        <li><span class="glyphicon glyphicon-indent-right"></span><span class="glyphicon-class">Picos de frecuencia:&nbsp;</span><span class=
                        "picos glyphicon-class">picos</span>&nbsp;Hz</li>
                
                        <li><span class="glyphicon glyphicon-sort-by-attributes-alt"></span><span class="glyphicon-class">Frecuencias:&nbsp;</span><span class="frecuenciasordenadas glyphicon-class">-</span></li>
                
                        <li><span class="glyphicon glyphicon-arrow-up"></span><span class="glyphicon-class">Mayor Frecuencia:&nbsp;<span class="frecuencia glyphicon-class">frecuencia</span>&nbsp;Hz</span></li>
                        <li class="db"><span class=" ojo glyphicon glyphicon glyphicon-eye-close"></span><span class="glyphicon-class">Umbral de detección:&nbsp;<span class="glyphicon-class">-6</span>&nbsp;dB</span></li>
                  
                    </ul>	
                </div>
            </div>

            <div class="col-md-7">
                <h3>El proceso de detección</h3>

                <p>El principal problema de utilizar el <a href=
                "espectro.html">Nodo Analizador</a> como elemento base en la
                detección de frecuencias, es la resolución en la parte baja del
                espectro. Nuesto ContextodeAudio utiliza una frecuencia de
                muestreo de 44100Hz, y ajustando el valor del tamaño de la
                Trasformada de Fourier a 2048, podemos crear vectores de 1024
                muestras, que en este caso se cuantifican con 1Byte. En este
                contexto, podemos rastrear en nuestro array de datos la
                secuencia armónica de cada nota y crear un filtro comparador
                para aproximar un valor. Las desviaciones de frecuencia de la
                muestra tomada, respecto al valor armónico original, están
                categorizadas en 3 tipos (±1Hz, ±5Hz y ±10Hz). a partir de las
                desviaciones de los cuatro primeros armónicos de cada cuerda,
                podemos aproximar una nota.</p>

                <p>En el display superior aparecen destacados los picos de
                frecuencia que superan el umbral de amplitud de 128. Este
                vector de picos es el que compararemos con un banco de notas.
                Por ejemplo un MI de la sexta cuerda se mostrará cuando los 3
                picos de más amplitud, correspondan a las posiciones 8, 15 y
                31.</p>

                <p>Las desviaciones de ¼ de tono sobre la nota, las determinará
                los armónicos superiores, en este caso el que ocupa la posición
                31, centrado en 667 Hz. La precisión aumentaría a un
                &amp;frac16; de tono si añadiéramos el valor del siguiente
                armonico (61) y podría mejorar si añadiésemos el siguiente
                (122), pero son armónicos de poco nivel que se enmascaran
                rápido.</p>
            </div>
        </div>

        <div class="row marketing">
            <div class="col-lg-8 table-responsive">
                <table class="table table-bordered table-condensed valores">
                    <thead>
                        <tr>
                            <th colspan="13" style="text-align:center">
                            Correspondencia de frecuencias</th>
                        </tr>

                        <tr>
                            <th>&nbsp;</th>

                            <th id="C">C</th>

                            <th id="Cs">C#</th>

                            <th id="D">D</th>

                            <th id="Eb">Eb</th>

                            <th id="E">E</th>

                            <th id="F">F</th>

                            <th id="Fs">F#</th>

                            <th id="G">G</th>

                            <th id="Gs">G#</th>

                            <th id="A">A</th>

                            <th id="Bb">Bb</th>

                            <th id="B">B</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr>
                            <td style="font-weight: bold">2</td>

                            <td data-placement="top" data-toggle="tooltip" id=
                            "3" title="± 1Hz. Posición de la muestra = 3">
                            65.41</td>

                            <td>69.30</td>

                            <td>73.42</td>

                            <td>77.78</td>

                            <td>82.41</td>

                            <td data-placement="top" data-toggle="tooltip" id=
                            "4" title="± 1Hz Posición de la muestra = 4. 86Hz">
                            87.31</td>

                            <td>92.50</td>

                            <td>98.00</td>

                            <td>103.8</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="5" title=
                            "± 5Hz. Posición de la muestra = 5. 107Hz">
                            110.0</td>

                            <td>116.5</td>

                            <td>123.5</td>
                        </tr>

                        <tr>
                            <td style="font-weight: bold">3</td>

                            <td data-placement="top" data-toggle="tooltip" id=
                            "6" title=
                            "± 1Hz Posición de la muestra = 6. 129Hz">
                            130.8</td>

                            <td>138.6</td>

                            <td>146.8</td>

                            <td class="aprox" data-placement="top" data-toggle=
                            "tooltip" id="7" title=
                            "± 5Hz Posición de la muestra = 7. 150Hz">
                            155.6</td>

                            <td>164.8</td>

                            <td class="aprox" data-placement="top" data-toggle=
                            "tooltip" id="8" title=
                            "± 5Hz Posición de la muestra = 8. 172Hz">
                            174.6</td>

                            <td>185.0</td>

                            <td>196.0</td>

                            <td class="aprox1" data-placement="top"
                            data-toggle="tooltip" id="10" title=
                            "± 10Hz Posición de la muestra = 10. 215Hz">
                            207.7</td>

                            <td>220.0</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="11" title=
                            "± 5Hz Posición de la muestra = 11. 236Hz">
                            233.1</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" title=
                            "± 10Hz Posición de la muestra = 11. 236Hz">
                            246.9</td>
                        </tr>

                        <tr>
                            <td style="font-weight: bold">4</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="12" title=
                            "± 5Hz Posición de la muestra = 12. 258Hz">
                            261.6</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="13" title=
                            "± 5Hz Posición de la muestra = 13. 279Hz">
                            277.2</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="14" title=
                            "± 10Hz Posición de la muestra = 14. 301Hz">
                            293.7</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" title=
                            "± 10Hz Posición de la muestra = 14. 301Hz">
                            311.1</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="15" title=
                            "± 10Hz Posición de la muestra = 15. 322Hz">
                            329.6</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="16" title=
                            "± 15Hz Posición de la muestra = 16. 344Hz">
                            349.2</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="17" title=
                            "± 5Hz Posición de la muestra = 17. 366Hz">
                            370.0</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="18" title=
                            "± 5Hz Posición de la muestra = 18. 687Hz">
                            392.0</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="19" title=
                            "± 10Hz Posición de la muestra = 19. 409Hz">
                            415.3</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="20" title=
                            "± 10Hz Posición de la muestra = 20. 430Hz">
                            440.0</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="22" title=
                            "± 10Hz Posición de la muestra = 22. 473Hz">
                            466.2</td>

                            <td data-placement="left" data-toggle="tooltip" id=
                            "23" title="± 1Hz Posición de la muestra = 23">
                            493.9</td>
                        </tr>

                        <tr>
                            <td style="font-weight: bold">5</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="24" title=
                            "± 10Hz Posición de la muestra = 24. 516Hz">
                            523.3</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="26" title=
                            "± 5Hz Posición de la muestra = 26. 559Hz">
                            554.4</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="27" title=
                            "± 10Hz Posición de la muestra = 27. 581Hz">
                            587.3</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="29" title=
                            "± 5Hz Posición de la muestra = 29. 624Hz">
                            622.3</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="31" title=
                            "± 10Hz Posición de la muestra = 31. 667Hz">
                            659.3</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="32" title=
                            "± 10Hz Posición de la muestra = 32. 689Hz">
                            698.5</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="34" title=
                            "± 10Hz Posición de la muestra = 34. 732Hz">
                            740.0</td>

                            <td>784.0</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="39" title=
                            "± 10Hz Posición de la muestra = 39. 839Hz">
                            830.6</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="41" title=
                            "± 5Hz Posición de la muestra = 41. 882Hz">
                            880.0</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="43" title=
                            "± 10Hz Posición de la muestra = 43. 925Hz">
                            932.3</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="46" title=
                            "± 5Hz Posición de la muestra = 46. 990Hz">
                            987.8</td>
                        </tr>

                        <tr>
                            <td style="font-weight: bold">6</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="49" title=
                            "± 10Hz Posición de la muestra = 49. 1055Hz">
                            1047</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="52" title=
                            "± 10Hz Posición de la muestra = 52. 1119Hz">
                            1109</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="55" title=
                            "± 10Hz Posición de la muestra = 55. 1184Hz">
                            1175</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="58" title=
                            "± 5Hz Posición de la muestra = 58. 1248Hz">
                            1245</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="61" title=
                            "± 10Hz Posición de la muestra = 61. 1313Hz">
                            1319</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="65" title=
                            "± 5Hz Posición de la muestra = 65. 1399Hz">
                            1397</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="69" title=
                            "± 5Hz Posición de la muestra = 69. 1485Hz">
                            1480</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="73" title=
                            "± 5Hz Posición de la muestra = 73. 1571Hz">
                            1568</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="77" title=
                            "± 5Hz Posición de la muestra = 77. 1658Hz">
                            1661</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="82" title=
                            "± 5Hz Posición de la muestra = 82. 1765Hz">
                            1760</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="87" title=
                            "± 10Hz Posición de la muestra = 87. 1873Hz">
                            1865</td>

                            <td>1976</td>
                        </tr>

                        <tr>
                            <td style="font-weight: bold">7</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="97" title=
                            "± 5Hz Posición de la muestra = 97. 2088Hz">
                            2093</td>

                            <td data-placement="left" data-toggle="tooltip" id=
                            "103" title=
                            "± 1Hz Posición de la muestra = 103. 2217Hz">
                            2217</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="109" title=
                            "± 5Hz Posición de la muestra = 109. 2347Hz">
                            2349</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="116" title=
                            "± 10Hz Posición de la muestra = 116. 2497Hz">
                            2489</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="122" title=
                            "± 10Hz Posición de la muestra = 122. 2627Hz">
                            2637</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="130" title=
                            "± 5Hz Posición de la muestra = 130. 2799">
                            2794</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="137" title=
                            "± 10Hz Posición de la muestra = 137. 2950Hz">
                            2960</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="146" title=
                            "± 10Hz Posición de la muestra = 146. 3143Hz">
                            3136</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="154" title=
                            "± 10Hz Posición de la muestra = 154. 3316Hz">
                            3322</td>

                            <td>3520</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="173" title=
                            "± 5Hz Posición de la muestra = 173. 1725Hz">
                            3729</td>

                            <td>3951</td>
                        </tr>

                        <tr>
                            <td style="font-weight: bold">8</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="194" title=
                            "± 10Hz Posición de la muestra = 194. 4177Hz">
                            4186</td>

                            <td data-placement="left" data-toggle="tooltip" id=
                            "206" title=
                            "± 1Hz Posición de la muestra = 206. 4435Hz">
                            4435</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="218" title=
                            "± 5Hz Posición de la muestra = 218. 4694Hz">
                            4699</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="231" title=
                            "± 5Hz Posición de la muestra = 231. 4974Hz">
                            4978</td>

                            <td data-placement="left" data-toggle="tooltip" id=
                            "245" title=
                            "± 1Hz Posición de la muestra = 245. 5275Hz">
                            5274</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="260" title=
                            "± 10Hz Posición de la muestra = 260. 5598Hz">
                            5588</td>

                            <td data-placement="left" data-toggle="tooltip" id=
                            "275" title=
                            "± 1Hz Posición de la muestra = 275. 5921Hz">
                            5920</td>

                            <td class="aprox" data-placement="left"
                            data-toggle="tooltip" id="291" title=
                            "± 1Hz Posición de la muestra = 291. 6266Hz">
                            6272</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="309" title=
                            "± 10Hz Posición de la muestra = 309. 6653Hz">
                            6645</td>

                            <td data-placement="left" data-toggle="tooltip" id=
                            "327" title=
                            "± 1Hz Posición de la muestra = 327. 7041Hz">
                            7040</td>

                            <td class="aprox1" data-placement="left"
                            data-toggle="tooltip" id="346" title=
                            "± 10Hz Posición de la muestra = 346. 7450Hz">
                            7459</td>

                            <td data-placement="left" data-toggle="tooltip" id=
                            "367" title=
                            "± 1Hz Posición de la muestra = 367. 7902Hz">
                            7902</td>
                        </tr>

                        <tr>
                            <td colspan="4">Código de colores:</td>

                            <td class="nota_baja_ley">Nota-</td>

                            <td class="nota_aprox_ley">Nota</td>

                            <td class="nota_alta_ley">Nota+</td>

                            <td class="ejsuccess" colspan="2">Armónico centrado
                            en ±1Hz</td>

                            <td class="ejwarning" colspan="2">Armónico centrado
                            en ±5Hz</td>

                            <td class="ejwarning1" colspan="2">Armónico
                            centrado en ±10Hz</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Resolución</h3>

                <div class="jumbotron" id="marco">
                    <canvas height="200" id="canvasresolucion" width=
                    "600"></canvas>
                </div>
            </div>

            <div class="col-md-12 col-lg-4">
                <h3>Precisión</h3>La detección basada en la carga armónica
                tiene una precisión limitada, sobre ¼ de tono para la parte
                baja de la guitarra y casi el doble para las 3 primeras cuerdas.
                Este ajuste se realiza con los armónicos superiores, donde la
                resolución de la trasformada nos permite distingir con más
                exactitud los intervalos de frecuencia. En la tabla de la
                izquierda aparecerán sombreadas las celdas de los armónicos
                detectados, y en caso de corresponder a una serie armónica
                determinada, se sombreará la cabecera con los códigos de las
                notas musicales.

                <p>El tamaño de cada muestra es de <strong>21.53Hz</strong>,
                que es la máxima resolución del analizador. Esta resolución es
                insuficiente para medir pasos &lt;5Hz en la parte baja del
                espectro de la guitarra, pero si seguimos el rastro armónico de
                la nota en la tabla de frecuencia y comparamos este grupo de
                valores con los armónicos de cada nota podemos mostrar en
                pantalla un resultado bastante aproximado.</p>

                <h3>Funcionamiento</h3>Una vez procesamos la petición
                <code>.webkitGetUserMedia</code> y creada la fuente de audio, podemos enrutar la señal en nuestra cadena de audio y comenzar el procesado.
El nodo analizador es clave para el análisis, pues nos proveerá los datos necesarios para realizar el cálculo o aproximación de nota, y utilizaremos la función <code>requestAnimationFrame</code> para realizar el análisis y el dibujo, solicitaremos los datos de la salida del nodo analizador para trabajar con ellos.

                
            </div>
        </div>

        <div class="row marketing">
            <div class="col-lg-12">
            <div class="highlight">
                    <pre class="prettyprint">
<code class="language-js">
//Tomamos un byte de enteros, array de 256 valores de amplitud y 1028 muestras
var ByteDatosFrec = new Uint8Array(analizador.frequencyBinCount);
analizador.getByteFrequencyData(ByteDatosFrec);

    </code>
</pre>
                </div>
                <p>Una vez contamos con un array de datos de la ventana de frecuencia, podemos recorrerlo para obtener sus picos, que serán los valores máximos del vector que superen un umbral.
Para optimizar el funcionamiento y descartar sonidos de fondo, se ha establecido un umbral en la detección de pico de valor 128 en la escala de amplitud de la señal, esto es la mitad del valor máximo que se puede detectar. Este sería el primer bloque del algoritmo de análisis.  </p>
<div class="highlight">
                    <pre class="prettyprint">
<code class="language-js">
//Recorrer el array de datos de frecuencia Comparar valores mayores que el umbral
for (var m = 0; m <= (ByteDatosFrec.length); m++) {
    var magnitud = ByteDatosFrec[m];
    var siguiente = ByteDatosFrec[m + 1];
    var anterior = ByteDatosFrec[m - 1];
    // se establece el umbral a 128. 
    if ((magnitud > maximo) && (magnitud > siguiente) && (magnitud > anterior) && (magnitud > 128)) {

        pico = magnitud;
        //Creamos nuestra matriz de valores y posiciones
        valores.push(pico);
        posiciones.push(m);

        var pos = m;
        var frecuencia = ((pos * contextoDeAudio.sampleRate) / contextoDeAudio.analizador.fftSize);
    }
    </code>
</pre>
                </div>
<p>Podemos enumerar las etapas del algoritmo de detección, de la siguiente manera:</p>


                <div class="panel panel-default pull-left">
                    <div class="panel-heading">
                        <h3 class="panel-title">Bloques de procesado</h3>
                    </div>

                    <div class="panel-body">
                        <ul class="list-unstyled">
                           
                            <li><strong>Bucle Comparador:</strong> recorre el vector de datos de frecuencia y selecciona los picos y sus posiciones. Sólo añade los valores detectados como pico y que superen el umbral de 128 valores del Byte. Se crean 2 vectores que formarán la matriz de posiciones y valores</li>
                            <li><strong>Adecuación de valores para visualización:</strong> se ordenan los picos por amplitud y se limitan a un número de entradas para una visualización óptima.</li>
                            <li><strong>Declaración de notas:</strong> Se declara un banco de 12 notas y sus desviaciones altas y bajas. Se utiliza una nemotécnica de incrementar o disminuir el valor del último armónico para el ajuste fino, por ejemplo:</li>
                        
                        <div class="highlight">
                    <pre class="prettyprint">
<code class="language-js">
         //A
        var A5 = [5, 10, 20, 41];
        var A5b = [5, 10, 20, 40];
        var A5bb = [5, 10, 20, 39];
        var A5a = [5, 10, 20, 42];
        var A5aa = [5, 10, 21, 42];
        var A2 = [10, 20, 41];
        
</code>
</pre>
                </div>
                        <p>En este fragmento de código se observa la declaración de la nota LA. Esta declaración de variables se ha optimizado para las notas susceptibles de mostrarse en la guitarra. En el ejemplo se observa la declaración de A5, que corresponde al LA de la 5ª cuerda tocada al aire, este valor es imprescindible durante el proceso de afinación general de una guitarra, así como el LA de la segunda cuerda al aire, por el que posiblemente pasemos al tensar la cuerda hacia el SI que corresponde a la 2ª cuerda en la afinación estándar. Los sufijos a, aa y b, bb indican los valores altos de esta nota que mostraremos en el display y que servirán al usuario para ajustar la tensión de la cuerda en una dirección y aproximarse al valor correcto de afinación.</p>
                        
                          <li><strong>Selección de nota</strong>: Este es el apartado que más se puede optimizar dentro bucle de análisis ya que por el momento consta de un condicional por cada posible nota. </li>
                          <li><strong>Visualización</strong>: Los valores se imprimen en pantalla en tiempo de ejecución de la interfaz <code>requestAnimationFrame</code>, por lo que el parpadeo es rápido. Esto es una buena cualidad para variaciones de tensión rápidas en la cuerda, que generen cambios de afinación repentinos.</li>
                         </ul>
                          
                          
                          
                          
                        </ul>
                    </div>
               
                       
                    </div>
               
               <h3>Forma de onda</h3>
        
                        <div class="jumbotron" id="marcoonda">
                            <canvas height="200" id="canvasonda" width="600"></canvas>
                        </div>
               
               
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© Luis Javier Gil 2013 |&nbsp; <a href=
            "https://github.com/lontafara/El-audio-en-la-web"><img alt="Github"
            src="imagenes/GitHub.png"></a></p>
        </div><script src="http://code.jquery.com/jquery-1.11.0.min.js"></script> <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script> <script src="http://getbootstrap.com/dist/js/bootstrap.min.js"></script> <script src="http://getbootstrap.com/assets/js/docs.min.js"></script> <script src="google-code-prettify/prettify.js" type=
"text/javascript"></script> <script>
$(function(){
        $('td').tooltip({container: 'body'});
		$('#pantalla').tooltip({container: 'body'});
        });

        </script> <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-28916569-4', 'estegrafico.com');
        ga('send', 'pageview');

        </script> <!--    <script>
           //Imptimir equivalencias de posición/frecuencia
        var equivalencias = Array();
        for ( var m = 0; m <= (1024); m++) {      
             var frecuencia = ((m*44100)/2048);
             equivalencias[m] = frecuencia;         
            
            }
            
        /*console.log(
            equivalencias
            //No se puede construir un afinador musical con esta resolución de transformada.
            )*/
                
                document.write("<h3>Intervalos de frecuencia:</h3></br><p>En Hz</p>");

                for (var c=0; c<equivalencias.length; c++)
                document.write(c +"&nbsp;&nbsp;  "+equivalencias[c] + "<br>");
            
            
            
            </script> -->
    </div>
</body>
</html>
